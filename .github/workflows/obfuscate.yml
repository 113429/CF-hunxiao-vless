# .github/workflows/obfuscate_encry.yml

name: 'Auto-Obfuscate and Overwrite encry.js'

on:
  schedule:
    - cron: '*/20 * * * *'
  workflow_dispatch:

permissions:
  contents: write 

jobs:
  obfuscate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20' 

      - name: Install javascript-obfuscator
        run: npm install -g javascript-obfuscator

      # 4. æ··æ·†æ–‡ä»¶å¹¶è¦†ç›–åŸæ–‡ä»¶
      - name: Obfuscate and Overwrite encry.js
        # âš ï¸ æ³¨æ„ï¼šè¿™é‡Œå®šä¹‰çš„å˜é‡ FILE_TO_OBFUSCATE ä»…åœ¨å½“å‰ Run æ­¥éª¤ä¸­æœ‰æ•ˆã€‚
        run: |
          FILE_TO_OBFUSCATE="encry.js"
          
          if [ -f "$FILE_TO_OBFUSCATE" ]; then
            echo "Starting obfuscation of $FILE_TO_OBFUSCATE..."
            javascript-obfuscator $FILE_TO_OBFUSCATE --output $FILE_TO_OBFUSCATE --compact true --control-flow-flattening true
            echo "Obfuscation complete. File $FILE_TO_OBFUSCATE has been overwritten."
          else
            echo "Warning: $FILE_TO_OBFUSCATE not found in the root directory. Skipping obfuscation."
            exit 0
          fi

      - name: Configure Git
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'

      # 6. æäº¤æ··æ·†åçš„æ›´æ”¹ (å·²ä¿®æ­£å˜é‡é—®é¢˜)
      - name: Commit and Push changes
        run: |
          # ã€ä¿®æ­£ã€‘åœ¨è¿™ä¸€æ­¥å†æ¬¡å®šä¹‰æ–‡ä»¶å˜é‡ï¼Œä»¥ç¡®ä¿å…¶åœ¨å½“å‰ shell ä¸­å¯ç”¨ã€‚
          FILE_TO_OBFUSCATE="encry.js" 
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å·²ä¿®æ”¹
          if [ -n "$(git status --porcelain $FILE_TO_OBFUSCATE)" ]; then
            echo "Changes detected in $FILE_TO_OBFUSCATE. Committing..."
            
            # æ˜ç¡®æ·»åŠ æ–‡ä»¶
            git add $FILE_TO_OBFUSCATE
            
            # æäº¤å¹¶æ¨é€
            git commit -m "ğŸ¤– Chore: Auto-obfuscate and overwrite encry.js"
            git push
            echo "Changes committed and pushed successfully."
          else
            echo "File not changed, skipping commit."
          fi
