# .github/workflows/obfuscate.yml

name: 'Obfuscate and Save to encry.js'

# è®¾ç½®è§¦å‘æ¡ä»¶
on:
  # 1. å®šæœŸè°ƒåº¦ (Cron Job)
  # '*/20 * * * *' è¡¨ç¤ºæ¯éš” 20 åˆ†é’Ÿè¿è¡Œä¸€æ¬¡ (UTC æ—¶é—´)ã€‚
  schedule:
    - cron: '*/20 * * * *'
  
  # 2. æ‰‹åŠ¨è¿è¡Œ (Workflow Dispatch)
  workflow_dispatch:

# å®šä¹‰å·¥ä½œæµä¸­çš„ä»»åŠ¡ï¼ˆJobï¼‰
jobs:
  obfuscate:
    # åœ¨æœ€æ–°çš„ Ubuntu è¿è¡Œå™¨ä¸Šè¿è¡Œ
    runs-on: ubuntu-latest

    # æ­¥éª¤
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # å¿…é¡»è®¾ç½® token æƒé™ï¼Œä»¥ä¾¿åœ¨åç»­æ­¥éª¤ä¸­æäº¤æ›´æ”¹
          token: ${{ secrets.GITHUB_TOKEN }}

      # 2. è®¾ç½® Node.js ç¯å¢ƒ
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20' 

      # 3. å®‰è£…æ··æ·†å™¨
      - name: Install javascript-obfuscator
        run: npm install -g javascript-obfuscator

      # 4. æ··æ·†æ–‡ä»¶å¹¶è¾“å‡ºåˆ° encry.js
      - name: Obfuscate vless.js to encry.js
        run: |
          INPUT_FILE="vless.js"
          OUTPUT_FILE="encry.js"
          
          if [ -f "$INPUT_FILE" ]; then
            echo "Starting obfuscation of $INPUT_FILE..."
            # æ‰§è¡Œæ··æ·†æ“ä½œï¼Œå°†ç»“æœè¾“å‡ºåˆ° OUTPUT_FILE
            # é»˜è®¤ä½¿ç”¨ç´§å‡‘æ¨¡å¼ (--compact true)
            javascript-obfuscator $INPUT_FILE --output $OUTPUT_FILE --compact true
            echo "Obfuscation complete. Result saved to $OUTPUT_FILE"
          else
            echo "Error: $INPUT_FILE not found in the root directory! Skipping job."
            # å¦‚æœæ‰¾ä¸åˆ°æºæ–‡ä»¶ï¼Œåˆ™ä¸ç»§ç»­æ‰§è¡Œåé¢çš„æäº¤æ­¥éª¤
            exit 0
          fi

      # 5. é…ç½® Git ç”¨æˆ·ä¿¡æ¯ï¼ˆç”¨äºæäº¤ï¼‰
      - name: Configure Git
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'

      # 6. æäº¤æ··æ·†åçš„æ›´æ”¹
      - name: Commit and Push encry.js
        run: |
          # æ£€æŸ¥ encry.js æ˜¯å¦å·²åˆ›å»ºæˆ–æ›´æ”¹
          if [ -f "encry.js" ] && [ -n "$(git status --porcelain encry.js)" ]; then
            git add encry.js
            git commit -m "ğŸ¤– Chore: Auto-generate encry.js from vless.js"
            git push
            echo "Changes committed and pushed."
          else
            echo "No changes detected in encry.js, skipping commit."
          fi
