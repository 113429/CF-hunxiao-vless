# .github/workflows/obfuscate_encry.yml

name: 'Auto-Obfuscate and Overwrite encry.js'

on:
  # 1. å®šæœŸè°ƒåº¦ (Cron Job)
  # '*/20 * * * *' è¡¨ç¤ºæ¯éš” 20 åˆ†é’Ÿè¿è¡Œä¸€æ¬¡ (UTC æ—¶é—´)ã€‚
  schedule:
    - cron: '*/20 * * * *'
  
  # 2. æ‰‹åŠ¨è¿è¡Œ (Workflow Dispatch)
  workflow_dispatch:

# ã€é‡è¦ã€‘æˆäºˆå·¥ä½œæµå†™å…¥æƒé™ç»™ contentsï¼Œä»¥å…è®¸æäº¤å’Œæ¨é€æ›´æ”¹ã€‚
permissions:
  contents: write 

jobs:
  obfuscate:
    runs-on: ubuntu-latest

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # 2. è®¾ç½® Node.js ç¯å¢ƒ
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20' 

      # 3. å®‰è£…æ··æ·†å™¨
      - name: Install javascript-obfuscator
        run: |
          echo "Installing javascript-obfuscator globally..."
          npm install -g javascript-obfuscator

      # 4. æ··æ·†æ–‡ä»¶å¹¶è¦†ç›–åŸæ–‡ä»¶
      - name: Obfuscate and Overwrite encry.js
        run: |
          FILE_TO_OBFUSCATE="encry.js"
          
          if [ -f "$FILE_TO_OBFUSCATE" ]; then
            echo "Starting obfuscation of $FILE_TO_OBFUSCATE..."
            
            # æ‰§è¡Œæ··æ·†æ“ä½œï¼Œè¾“å…¥å’Œè¾“å‡ºæ–‡ä»¶è·¯å¾„ç›¸åŒï¼Œå®ç°åŸåœ°è¦†ç›–ã€‚
            # è¿™é‡Œæˆ‘åŠ å…¥äº†ä½ å¯èƒ½éœ€è¦çš„æ··æ·†å¢å¼ºé€‰é¡¹ï¼Œä½ å¯ä»¥æŒ‰éœ€è°ƒæ•´ã€‚
            javascript-obfuscator $FILE_TO_OBFUSCATE --output $FILE_TO_OBFUSCATE --compact true --control-flow-flattening true
            
            echo "Obfuscation complete. File $FILE_TO_OBFUSCATE has been overwritten."
          else
            echo "Warning: $FILE_TO_OBFUSCATE not found in the root directory. Skipping obfuscation."
            # å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œé€€å‡ºå¹¶æ ‡è®°ä¸ºæˆåŠŸï¼ˆé€€å‡ºä»£ç  0ï¼‰ï¼Œä¸è¿›è¡Œåç»­æäº¤ã€‚
            exit 0
          fi

      # 5. é…ç½® Git ç”¨æˆ·ä¿¡æ¯ï¼ˆæœºå™¨äººèº«ä»½ï¼‰
      - name: Configure Git
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'

      # 6. æäº¤æ··æ·†åçš„æ›´æ”¹
      - name: Commit and Push changes
        run: |
          # æ£€æŸ¥ encry.js æ–‡ä»¶æ˜¯å¦å‘ç”Ÿäº†æ›´æ”¹
          if [ -n "$(git status --porcelain $FILE_TO_OBFUSCATE)" ]; then
            git add $FILE_TO_OBFUSCATE
            git commit -m "ğŸ¤– Chore: Auto-obfuscate and overwrite encry.js"
            git push
            echo "Changes committed and pushed."
          else
            echo "File not changed (likely already obfuscated), skipping commit."
          fi
